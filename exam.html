<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ทำข้อสอบ | AiAm practice exam online</title>
  <style>
    :root{--bg:#f5f9ff;--card:#ffffff;--accent:#0b74da;--muted:#6b7280;--success:#16a34a;--danger:#dc2626}
    *{box-sizing:border-box}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#0f172a}
    header{background:#0b74da;color:#fff;padding:18px;text-align:center;font-weight:700}
    .wrap{max-width:880px;margin:28px auto;padding:20px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 20px rgba(11,37,71,0.06)}
    .progress{height:10px;background:#e6eefc;border-radius:999px;overflow:hidden;margin:12px 0}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#38bdf8);width:0}
    .qnum{font-weight:600;color:var(--accent)}
    .question{margin:8px 0 16px;font-size:18px}
    .choices{display:flex;flex-direction:column;gap:10px}
    .choice{border:1px solid #e6eefc;padding:12px;border-radius:10px;cursor:pointer;display:flex;align-items:center;gap:12px}
    .choice input{accent-color:var(--accent)}
    .controls{display:flex;justify-content:space-between;gap:12px;margin-top:16px}
    button{background:var(--accent);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6eefc}
    button:disabled{opacity:.5;cursor:not-allowed}
    .result{padding:14px;border-radius:10px;margin-top:14px}
    .score{font-size:20px;font-weight:700}
    .correct{color:var(--success);font-weight:700}
    .incorrect{color:var(--danger);font-weight:700}
    footer.small{margin-top:18px;color:var(--muted);font-size:13px}
    .meta{display:flex;gap:8px;align-items:center;margin:8px 0 12px;color:var(--muted)}
    input[type=text]{padding:10px;border:1px solid #e6eefc;border-radius:10px;width:100%}
  </style>
</head>
<body>
  <header>ทำข้อสอบ — AiAm practice exam online</header>
  <div class="wrap">
    <main class="card" id="app">
      <div class="meta">
        <label for="username">ชื่อผู้ทำ: </label>
        <input id="username" type="text" placeholder="พิมพ์ชื่อของคุณที่นี่" />
        <button id="startBtn" class="ghost">เริ่มทำแบบทดสอบ</button>
      </div>

      <div class="progress" aria-hidden><i id="progressBar"></i></div>
      <div id="questionArea"></div>

      <div class="controls">
        <button class="ghost" id="prevBtn" disabled>Previous</button>
        <button id="nextBtn" disabled>Next</button>
      </div>

      <div id="finalArea"></div>
    </main>
    <footer class="small" style="text-align:center">© 2025 AiAm practice exam online — ข้อมูลบันทึกลง Firebase</footer>
  </div>

  <script type="module">
    // ✅ วาง firebaseConfig ของคุณที่นี่
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, (user)=>{ currentUser = user; });

    // อ่าน test id จากพารามิเตอร์
    const params = new URLSearchParams(window.location.search);
    const testId = params.get("test") || "toeic-set1";

    // ชุดคำถามตาม testId
    const BANK = {
      "toeic-set1": [
        {q:"The company will __________ the new software next month.", choices:["launch","launched","be launching","launches"], answer:0, expl:"will + V1 → launch = จะเปิดตัว"},
        {q:"She has been working here _____ 2018.", choices:["for","since","from","in"], answer:1, expl:"since + จุดเวลา (2018) / for + ระยะเวลา"},
        {q:"If you have any questions, please _____ to contact our support team.", choices:["feel free","feel","to feel","feel it"], answer:0, expl:"สำนวน feel free to + V (เชิญตามสบาย)"},
        {q:"The meeting will be held _____ the conference room on the second floor.", choices:["in","at","on","over"], answer:1, expl:"สถานที่เฉพาะเจาะจงนิยมใช้ at"},
        {q:"By the time the manager arrives, we _____ finished the report.", choices:["will have","have","had","will be"], answer:0, expl:"Future perfect: will have + V3"},
        {q:"The shipment was delayed due to _____ weather conditions.", choices:["inclement","inclined","including","incomplete"], answer:0, expl:"inclement = อากาศเลวร้าย"},
        {q:"He _____ in three different countries during his career.", choices:["lived","has lived","will live","is living"], answer:1, expl:"Present perfect → has lived"},
        {q:"She gave _____ excellent presentation yesterday.", choices:["a","an","the","no article"], answer:1, expl:"เสียงสระ (excellent) → an"},
        {q:"The CEO wanted to cut costs; _____, they postponed the project.", choices:["therefore","however","moreover","in fact"], answer:1, expl:"however = อย่างไรก็ตาม (ขัดแย้ง)"},
        {q:"Please ensure all employees _____ the safety procedures before starting.", choices:["familiarize","are familiar with","familiarized","will be familiar"], answer:1, expl:"are familiar with = คุ้นเคย"},
        {q:"The policy applies _____ all full-time staff.", choices:["for","to","with","on"], answer:1, expl:"apply to + ผู้ถูกบังคับใช้"},
        {q:"Neither the manager nor the assistants _____ available today.", choices:["is","are","were","be"], answer:1, expl:"ตามประธานที่ใกล้สุด assistants → are"},
        {q:"The revised schedule _____ published on Monday.", choices:["was","were","is","are"], answer:0, expl:"schedule เอกพจน์ + passive อดีต → was published"},
        {q:"He recommended _____ the contract before signing.", choices:["to review","reviewing","review","to reviewing"], answer:1, expl:"recommend + V-ing"},
        {q:"They offered him a position _____ marketing manager.", choices:["as","to be","for","in"], answer:0, expl:"as + ตำแหน่ง"},
        {q:"The report provides a _____ analysis of market trends.", choices:["comprehensive","comprehend","comprehending","comprehension"], answer:0, expl:"ต้องการ adj. → comprehensive"},
        {q:"If she _____ earlier, she would have caught the train.", choices:["had left","left","would leave","leaves"], answer:0, expl:"เงื่อนไขที่ 3 → had + V3"},
        {q:"They insisted that the meeting _____ moved to next week.", choices:["be","is","was","will be"], answer:0, expl:"subjunctive → be moved"},
        {q:"The new software is more _____ than the previous version.", choices:["user-friendly","user friendlier","more user friendly","user-friendlyer"], answer:0, expl:"รูปถูกต้อง user-friendly"},
        {q:"The team was praised _____ their outstanding performance.", choices:["for","with","by","to"], answer:0, expl:"praised for + สิ่งที่ได้รับคำชม"}
      ],
      "pakor-set1": [
        {q:"ภาษาไทยเป็น _______ ประจำชาติไทย", choices:["ภาษา","ศาสนา","เพลง","ธง"], answer:0, expl:"องค์ประกอบประจำชาติ เช่น ภาษา ศาสนา พระมหากษัตริย์ ฯลฯ"},
        {q:"ข้อใดเป็นจำนวนเฉพาะ", choices:["21","31","33","35"], answer:1, expl:"31 หารลงตัวด้วย 1 และตัวเองเท่านั้น"},
        {q:"พันธกิจของ ก.พ. เกี่ยวข้องกับข้อใด", choices:["การคลัง","กำลังคนภาครัฐ","ความมั่นคง","เกษตร"], answer:1, expl:"สำนักงาน ก.พ. ดูแลกำลังคนภาครัฐ"},
        {q:"ข้อใดสะกดถูก", choices:["ทรัพยกร","ทรัพยการ","ทรัพยากร","ทรัพยาก"], answer:2, expl:"สะกดที่ถูกต้อง: ทรัพยากร"},
        {q:"ค่าเฉลี่ยของชุดข้อมูล 2, 4, 6, 8 เท่ากับเท่าใด", choices:["4","5","6","7"], answer:1, expl:"(2+4+6+8)/4 = 5"}
      ]
    };

    const QUESTIONS = BANK[testId] || BANK["toeic-set1"];

    // สถานะทำข้อสอบ
    let current = 0;
    const answers = Array(QUESTIONS.length).fill(null);
    let userName = "";

    // อ้างอิง element
    const progressBar = document.getElementById('progressBar');
    const questionArea = document.getElementById('questionArea');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const startBtn = document.getElementById('startBtn');
    const usernameInput = document.getElementById('username');
    const finalArea = document.getElementById('finalArea');

    // เริ่มทำข้อสอบ
    startBtn.addEventListener('click', ()=>{
      const name = usernameInput.value.trim();
      if(!name){ alert('กรุณาพิมพ์ชื่อก่อนเริ่มทำแบบทดสอบ'); return; }
      userName = name;
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      startBtn.disabled = true;
      usernameInput.disabled = true;
      renderQuestion(current);
    });

    function renderQuestion(i){
      const item = QUESTIONS[i];
      progressBar.style.width = (i/QUESTIONS.length*100+5) + '%';

      questionArea.innerHTML = `
        <div>
          <div class="qnum">ข้อที่ ${i+1} จาก ${QUESTIONS.length}</div>
          <div class="question">${item.q}</div>
          <div class="choices">
            ${item.choices.map((ch, idx)=>
              `<label class='choice'>
                <input type='radio' name='choice' value='${idx}'> ${String.fromCharCode(65+idx)}. ${ch}
              </label>`).join('')}
          </div>
          <div id='feedback' style='margin-top:12px;font-weight:600;'></div>
          <div id='explanation' style='margin-top:6px;color:#64748b;'></div>
        </div>`;

      prevBtn.disabled = i===0;
      nextBtn.textContent = (i===QUESTIONS.length-1)? 'Finish' : 'Next';

      document.querySelectorAll('input[name=choice]').forEach((el,idx)=>{
        el.addEventListener('change',()=>{
          answers[i]=idx;
          const fb=document.getElementById('feedback');
          const ex=document.getElementById('explanation');
          if(idx===item.answer){
            fb.innerHTML = '<span class="correct">✅ ถูกต้อง</span>';
          } else {
            fb.innerHTML = `<span class="incorrect">❌ ไม่ถูกต้อง</span> (คำตอบที่ถูก: <strong>${String.fromCharCode(65+item.answer)}. ${item.choices[item.answer]}</strong>)`;
          }
          ex.innerHTML = 'คำอธิบาย: '+item.expl;
        });
      });
    }

    prevBtn.addEventListener('click', ()=>{ if(current>0){ current--; renderQuestion(current); } });
    nextBtn.addEventListener('click', ()=>{ if(current<QUESTIONS.length-1){ current++; renderQuestion(current); } else { showResults(); } });

    async function showResults(){
      let correct=0;
      QUESTIONS.forEach((q,i)=>{ if(answers[i]===q.answer) correct++; });
      const percent = Math.round(correct/QUESTIONS.length*100);

      finalArea.innerHTML = `
        <div class='result'>
          <div class='score'>🎉 Congratulations! You’ve finished the test.</div>
          <div class='score'>คะแนน: ${correct} / ${QUESTIONS.length} (${percent}%)</div>
          <div style='margin-top:6px;color:#64748b'>กำลังบันทึกคะแนนไปยัง Firebase...</div>
        </div>`;
      finalArea.scrollIntoView({behavior:'smooth'});

      try {
        if(!currentUser) throw new Error('ยังไม่ได้เข้าสู่ระบบแบบไม่ระบุตัวตน');
        await addDoc(collection(db, "results"), {
          name: userName,
          score: correct,
          total: QUESTIONS.length,
          percent: percent,
          testId,
          createdAt: serverTimestamp(),
          uid: currentUser.uid
        });
      } catch(err) {
        console.error(err);
        finalArea.innerHTML += `<div style='margin-top:8px;color:#dc2626'>⚠️ บันทึกไม่สำเร็จ: ${err.message}</div>`;
      }
    }
  </script>
</body>
</html>
